<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forgot Password - SmartCal</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .auth-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 40px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .auth-form input {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
        }
        .auth-form button {
            padding: 12px;
            background: #000;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
        }
        .auth-form button:hover {
            background: #333;
        }
        .auth-links {
            text-align: center;
            margin-top: 20px;
        }
        .auth-links a {
            color: #007bff;
            text-decoration: none;
        }
        .error-message {
            color: #dc3545;
            text-align: center;
            margin-top: 10px;
        }
        .success-message {
            color: #28a745;
            text-align: center;
            margin-top: 10px;
        }
        .back-button {
            background: #6c757d;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            margin-right: 10px;
        }
        .back-button:hover {
            background: #5a6268;
        }
        .button-group {
            display: flex;
            gap: 10px;
        }
        .continue-btn {
            flex: 1;
        }
        .page-header {
            text-align: center;
            margin-bottom: 30px;
        }
        .page-header h2 {
            margin-bottom: 10px;
            color: #333;
        }
        .page-header p {
            color: #666;
            font-size: 14px;
        }
        .step {
            display: none;
        }
        .step.active {
            display: block;
        }
        .otp-input {
            letter-spacing: 8px;
            font-size: 20px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="auth-container">
        <div class="page-header">
            <h2>Forgot Password</h2>
            <p id="step-description">Enter your email address to reset your password.</p>
        </div>
        
        <!-- Step 1: Email Input -->
        <div class="step active" id="step-email">
            <form class="auth-form" id="emailForm">
                <input type="email" id="resetEmail" placeholder="Enter your email address" required>
                
                <div class="button-group">
                    <button type="submit" class="continue-btn">Continue</button>
                </div>
            </form>
        </div>
        
        <!-- Step 2: OTP Verification -->
        <div class="step" id="step-otp">
            <form class="auth-form" id="otpForm">
                <input type="text" id="otpInput" class="otp-input" placeholder="Enter 6-digit OTP" maxlength="6" required>
                
                <div class="button-group">
                    <button type="button" class="back-button" onclick="showStep('step-email')">Back</button>
                    <button type="submit" class="continue-btn">Verify OTP</button>
                </div>
            </form>
        </div>
        
        <!-- Step 3: New Password -->
        <div class="step" id="step-password">
            <form class="auth-form" id="passwordForm">
                <input type="password" id="newPassword" placeholder="New Password" required>
                <input type="password" id="confirmPassword" placeholder="Confirm New Password" required>
                
                <div class="button-group">
                    <button type="button" class="back-button" onclick="showStep('step-otp')">Back</button>
                    <button type="submit" class="continue-btn">Reset Password</button>
                </div>
            </form>
        </div>
        
        <div class="error-message" id="errorMessage"></div>
        <div class="success-message" id="successMessage"></div>
        
        <div class="auth-links">
            <a href="login.html">Back to Login</a>
        </div>
    </div>

    <script>
        // Global variables
        let userEmail = '';
        
        // Function to show a specific step
        function showStep(stepId) {
            // Hide all steps
            document.querySelectorAll('.step').forEach(step => {
                step.classList.remove('active');
            });
            
            // Show the requested step
            document.getElementById(stepId).classList.add('active');
            
            // Update the step description
            const stepDescription = document.getElementById('step-description');
            
            switch(stepId) {
                case 'step-email':
                    stepDescription.textContent = 'Enter your email address to reset your password.';
                    break;
                case 'step-otp':
                    stepDescription.textContent = 'Enter the 6-digit OTP sent to your email.';
                    break;
                case 'step-password':
                    stepDescription.textContent = 'Create a new password for your account.';
                    break;
            }
            
            // Clear error and success messages
            document.getElementById('errorMessage').textContent = '';
            document.getElementById('successMessage').textContent = '';
        }
        
        // Step 1: Email Form Submission
        document.getElementById('emailForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('resetEmail').value;
            const errorMessage = document.getElementById('errorMessage');
            const successMessage = document.getElementById('successMessage');
            
            // Clear previous messages
            errorMessage.textContent = '';
            successMessage.textContent = '';
            
            if (!email) {
                errorMessage.textContent = 'Please enter your email address.';
                return;
            }
            
            // Email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                errorMessage.textContent = 'Please enter a valid email address.';
                return;
            }
            
            try {
                // Send request to backend to check if email exists and send OTP
                const response = await fetch('/users/forgot-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Store email for later use
                    userEmail = email;
                    
                    // Show success message
                    successMessage.textContent = data.message || 'OTP sent to your email address.';
                    
                    // Move to OTP verification step
                    setTimeout(() => {
                        showStep('step-otp');
                    }, 1500);
                } else {
                    // Show error message
                    errorMessage.textContent = data.detail || 'An error occurred. Please try again.';
                }
            } catch (error) {
                console.error('Error sending reset email:', error);
                errorMessage.textContent = 'An error occurred. Please try again.';
            }
        });
        
        // Step 2: OTP Form Submission
        document.getElementById('otpForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const otp = document.getElementById('otpInput').value;
            const errorMessage = document.getElementById('errorMessage');
            const successMessage = document.getElementById('successMessage');
            
            // Clear previous messages
            errorMessage.textContent = '';
            successMessage.textContent = '';
            
            if (!otp) {
                errorMessage.textContent = 'Please enter the OTP.';
                return;
            }
            
            if (otp.length !== 6) {
                errorMessage.textContent = 'OTP must be 6 digits.';
                return;
            }
            
            try {
                // Send request to backend to verify OTP
                const response = await fetch('/users/verify-reset-otp', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        email: userEmail,
                        otp: otp 
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Show success message
                    successMessage.textContent = data.message || 'OTP verified successfully.';
                    
                    // Move to password reset step
                    setTimeout(() => {
                        showStep('step-password');
                    }, 1500);
                } else {
                    // Show error message
                    errorMessage.textContent = data.detail || 'Invalid OTP. Please try again.';
                }
            } catch (error) {
                console.error('Error verifying OTP:', error);
                errorMessage.textContent = 'An error occurred. Please try again.';
            }
        });
        
        // Step 3: Password Form Submission
        document.getElementById('passwordForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const errorMessage = document.getElementById('errorMessage');
            const successMessage = document.getElementById('successMessage');
            
            // Clear previous messages
            errorMessage.textContent = '';
            successMessage.textContent = '';
            
            // Validate passwords
            if (!newPassword || !confirmPassword) {
                errorMessage.textContent = 'Please enter both passwords.';
                return;
            }
            
            if (newPassword !== confirmPassword) {
                errorMessage.textContent = 'Passwords do not match.';
                return;
            }
            
            if (newPassword.length < 8) {
                errorMessage.textContent = 'Password must be at least 8 characters long.';
                return;
            }
            
            try {
                // Send request to backend to reset password
                const response = await fetch('/users/reset-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        email: userEmail,
                        password: newPassword 
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Show success message
                    successMessage.textContent = data.message || 'Password reset successfully.';
                    
                    // Redirect to login page after a delay
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 2000);
                } else {
                    // Show error message
                    errorMessage.textContent = data.detail || 'An error occurred. Please try again.';
                }
            } catch (error) {
                console.error('Error resetting password:', error);
                errorMessage.textContent = 'An error occurred. Please try again.';
            }
        });
    </script>
</body>
</html>